<!DOCTYPE html>
<html lang="en">
    <head>
        <title>The Flying Tomato</title>
        <meta charset="UTF-8">
        <meta name="description" content="Build your perfect pizza or choose from our specialty menu.">
        <meta name="keywords" content="pizza, custom pizza, specialty pizzas, pepperoni, gourmet, The Flying Tomato">
        <meta name="display" content="width=device-width initial-scale=1.0">
        <link rel="stylesheet" href="styles/style.css">
        <link rel="icon" href="./images/logo.png" type="image/x-icon">
        <script src="main.js"></script>
        <style>
            /* Base styles from original HTML */
            aside {
                float: right;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
                width: 30%;
                background-color: #fff3e0;
                padding: 10px;
                box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
                border:2px solid #ccc;
                border-radius: 8px;
            }
            aside div {
                margin-bottom: 15px;
                text-align: center;
                width:40%;
                height: auto;
                border: 2px solid #ccc;
                border-radius: 8px;
            }
            aside img {
                max-width: 100%;
                height: auto;
                border-radius: 8px;
            }
            aside button {
                margin-top: 5px;
                padding: 8px 12px;
                background-color: #f77f00;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.5s;
            }
            aside button:hover {
                background-color: #d96e00;
            }
            aside h2 {
                text-align: center;
                margin-bottom: 15px;
                width: 100%;
            }
            .title {
                color:#e63946;
                font-size:clamp(30px,40px,45px);
            }
            /* Specialty Pizza Styles (merged from provided CSS) */
            #figures {
                display: flex;
                justify-content: center;
                margin: 20px 0; /* Adjusted margin */
                gap: 20px; /* Space between pizza cards */
                clear: both; /* Ensure it appears below the floating aside */
                
            }
            .specialty-section {
                /* Ensures the section doesn't wrap around the aside */
                display: block; 
                margin-bottom: 40px;
            }
            figure {
                display: flex;
                flex-direction: column;
                width: clamp(250px, 30%, 30%); 
                background-color: #fff3e0;
                border: 2px solid #f77f00;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                padding: 15px;
                text-align: center;
            }
            figcaption {
                font-size: 1.1em;
                padding: 10px 0;
                color: #003049;
            }
            figure img {
                margin-bottom: 10px;
                width: 100%;
                height: auto; 
                max-height: 250px;
                object-fit: cover;
                border-radius: 4px;
            }
            .add-to-cart-btn {
                background-color: #2a9d8f; 
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
                transition: background-color 0.3s;
            }
            .add-to-cart-btn:hover {
                background-color: #1e7d70;
            }
            /* New Checkout Styles */
            #checkout-section {
                float: left;
                width: 65%; /* Max width to accommodate the aside */
                padding: 20px;
                background-color: #eae2b7; /* Light background for contrast */
                border: 2px solid #f77f00;
                border-radius: 8px;
                margin: 20px 0;
            }
            #cart-items li {
                background-color: #fff3e0;
                padding: 8px;
                margin: 5px 0;
                border-radius: 4px;
                list-style: none;
                border-left: 5px solid #d62828;
            }
            #cart-items {
                padding: 0;
            }
        </style>
    </head>

    <body class="fadeInUp-animation">
        <div id="group">
            <header>
                <a href="./index.html"><img src="./images/logo.png" alt="The flying tomato Logo"></a>
            </header>
            <nav>
                    <a href="./index.html" id="here">Home</a>
                     <a href="ball.html">The Pizzaball War</a>
                    <a href="./pizza.html">Build your own pizza</a>
            </nav>
        </div>
        <aside>
                <h2>Options</h2>
                <div>
                    <h3>Pepperoine</h3>
                    <img src="images/pepperoni.png" alt="pepperoni">
                    <button type="button" class="topping-btn" data-id="pepperoni" data-name="Pepperoni" data-src="images/pepperoni.png">Select</button>
                </div>
                <div>
                    <h3>Sasuage</h3>
                    <img src="images/sasuage.png" alt="sasuage">
                    <button type="button" class="topping-btn" data-id="sausage" data-name="Sausage" data-src="images/sasuage.png">Select</button>
                </div>
                <div>
                    <h3>Bacon</h3>
                    <img src="images/bacon.png" alt="bacon">
                    <button type="button" class="topping-btn" data-id="bacon" data-name="Bacon" data-src="images/bacon.png">Select</button>
                </div>
                <div>
                    <h3>Pineapple</h3>
                    <img src="images/pineapple.png" alt="pineapple">
                    <button type="button" class="topping-btn" data-id="pineapple" data-name="Pineapple" data-src="images/pineapple.png">Select</button>
                </div>
                <div>
                    <h3>muchroom</h3>
                    <img src="images/mushroom.png" alt="mushroom">
                    <button type="button" class="topping-btn" data-id="mushroom" data-name="Mushroom" data-src="images/mushroom.png">Select</button>
                </div>
                <div>
                    <h3>Cherry tomato</h3>
                    <img src="images/tomato.png" alt="tomato">
                    <button type="button" class="topping-btn" data-id="tomato" data-name="Tomato" data-src="images/tomato.png">Select</button>
                </div>
            </aside>
        
        <main>
            <h1 class="title">Build Your Own Pizza!</h1>

            <canvas id="pizzaCanvas" width="700" height="700" style="border:2px solid #dcdcdc; border-radius:8px; max-width:100%; height:auto; display:block; margin: 0 auto; background-image: url('images/cutting.png'); background-size: 150% auto; background-position: center; background-repeat: no-repeat; background-color: transparent;"></canvas>
            
            <div style="text-align:center; margin-top:10px;">
                <div id="selectedPreview" style="display:inline-block; padding:6px 12px; border-radius:6px; background:#fff; border:1px dashed #ccc">Selected: <span id="selectedName">None</span></div>
                <button id="resetBtn" style="margin-left:12px; padding:8px 12px; background:#e63946;color:#fff;border:none;border-radius:6px;cursor:pointer">Reset</button>
                <button id="addCustomToCartBtn" style="margin-left:8px; padding:8px 12px; background:#2a9d8f;color:#fff;border:none;border-radius:6px;cursor:pointer">Add Custom Pizza to Cart</button>
            </div>

            <section class="specialty-section">
                <h2 class="title" style="margin-top: 60px;">Our Specialty Pizzas</h2>
                <div id="figures">
                    <figure>
                        <h3>The Gordan</h3> 
                        <img src="./images/TheGordan.jpg" alt="A delicious Margherita pizza with fresh basil and mozzarella">
                        <figcaption>Our signature Margherita pizza, topped with fresh basil and mozzarella.
                            <br><button type="button" class="add-to-cart-btn" data-pizza-name="The Gordan">Add to Cart</button>
                        </figcaption>
                        
                    </figure>
                    <figure>
                        <h3>The Dawg</h3>
                        <img src="./images/TheDawg.jpg" alt="A delicious Meat Lover's pizza, loaded with pepperoni, sausage, and bacon">
                        <figcaption>Our Meat Lover's pizza, loaded with pepperoni, sausage, and bacon.
                            <br><button type="button" class="add-to-cart-btn" data-pizza-name="The Dawg">Add to Cart</button>
                        </figcaption>
                        
                    </figure>
                    <figure>
                        <h3>Goozine Cuzinee</h3>
                        <img src="./images/GoozineCuzinee.webp" alt="A delicious Veggie Delight pizza">
                        <figcaption>Our Veggie Delight pizza.
                            <br><button type="button" class="add-to-cart-btn" data-pizza-name="Goozine Cuzinee">Add to Cart</button>
                        </figcaption>
                    </figure>
                </div>
            </section>
            <section id="checkout-section">
                <h2 class="title" style="font-size: 2em; margin-bottom: 15px;">Checkout Summary</h2>
                <div id="cart-content">
                    <ul id="cart-items">
                        <li id="empty-cart-message">Your cart is empty.</li>
                    </ul>
                    <p style="font-weight: bold; margin-top: 15px;">Total Items: <span id="total-items">0</span></p>
                    <button id="finalCheckoutBtn" style="padding: 10px 20px; background:#e63946;color:#fff;border:none;border-radius:6px;cursor:pointer; margin-top: 10px;">Proceed to Payment</button>
                </div>
            </section>
            <script>
                (function(){
                    const canvas = document.getElementById('pizzaCanvas');
                    const ctx = canvas.getContext('2d');
                    const toppingButtons = Array.from(document.querySelectorAll('.topping-btn'));
                    const addToCartButtons = Array.from(document.querySelectorAll('.add-to-cart-btn'));
                    const resetBtn = document.getElementById('resetBtn');
                    const addCustomToCartBtn = document.getElementById('addCustomToCartBtn');
                    const finalCheckoutBtn = document.getElementById('finalCheckoutBtn');
                    const cartItemsList = document.getElementById('cart-items');
                    const emptyCartMessage = document.getElementById('empty-cart-message');
                    const totalItemsSpan = document.getElementById('total-items');

                    // constants
                    const W = canvas.width;
                    const H = canvas.height;
                    const cx = W/2, cy = H/2;
                    const OUTER_R = Math.min(W,H)/2 - 30;
                    const SAUCE_R = OUTER_R - 40;
                    const NUM_SLICES = 8;
                    const STORAGE_KEY = 'pizza_builder_state';

                    const state = {
                        selected: null,
                        slices: Array.from({length:NUM_SLICES}, ()=>[]), 
                        cart: []
                    };

                    // images
                    const toppingImages = {};
                    const preloadPromises = toppingButtons.map(btn=>{
                        const src = btn.dataset.src;
                        const id = btn.dataset.id;
                        return new Promise((resolve)=>{
                            const img = new Image();
                            img.src = src;
                            img.onload = ()=>{ toppingImages[id]=img; resolve(); };
                            img.onerror = ()=>{ console.warn('Failed to load',src); resolve(); };
                        });
                    });

                    // canvas drawing functions
                    function drawBase(){
                        ctx.clearRect(0,0,W,H);
                        // crust
                        ctx.beginPath();
                        ctx.arc(cx,cy,OUTER_R,0,Math.PI*2);
                        ctx.fillStyle = '#f4c27a';
                        ctx.fill();

                        // sauce/cheese
                        ctx.beginPath();
                        ctx.arc(cx,cy,SAUCE_R,0,Math.PI*2);
                        ctx.fillStyle = '#ffea5b';
                        ctx.fill();

                        // draw slice separators
                        ctx.strokeStyle = 'rgba(0,0,0,0.06)';
                        ctx.lineWidth = 2;
                        for(let i=0;i<NUM_SLICES;i++){
                            const ang = (i/NUM_SLICES)*Math.PI*2;
                            ctx.beginPath();
                            ctx.moveTo(cx,cy);
                            ctx.lineTo(cx + Math.cos(ang)*OUTER_R, cy + Math.sin(ang)*OUTER_R);
                            ctx.stroke();
                        }
                    }

                    function redraw(){
                        drawBase();
                        // draw toppings
                        for(let s=0;s<NUM_SLICES;s++){
                            const list = state.slices[s];
                            for(const t of list){
                                const img = toppingImages[t.id];
                                if(!img) continue;
                                const size = t.size || 36;
                                ctx.drawImage(img, t.x - size/2, t.y - size/2, size, size);
                            }
                        }
                    }

                    // utility functions
                    function getSliceIndexFromCoord(x,y){
                        const angle = Math.atan2(y - cy, x - cx);
                        let deg = angle * 180/Math.PI;
                        if(deg < 0) deg += 360;
                        const slice = Math.floor(deg / (360/NUM_SLICES));
                        return slice;
                    }

                    function canvasCoordsFromEvent(e){
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        const x = (e.clientX - rect.left) * scaleX;
                        const y = (e.clientY - rect.top) * scaleY;
                        return {x,y};
                    }

                    function getCustomPizzaDescription(slices) {
                        const allToppings = slices.flat();
                        if (allToppings.length === 0) return "Plain Cheese Pizza (No Toppings)";

                        const counts = allToppings.reduce((acc, topping) => {
                            acc[topping.id] = (acc[topping.id] || 0) + 1;
                            return acc;
                        }, {});

                        const toppingNames = Object.keys(counts).map(id => {
                            const toppingName = toppingButtons.find(btn => btn.dataset.id === id)?.dataset.name || id;
                            return `${toppingName} (${counts[id]})`;
                        });
                        return `Custom Pizza w/ ${toppingNames.join(', ')}`;
                    }

                    function renderCart() {
                        cartItemsList.innerHTML = '';

                        if (state.cart.length === 0) {
                            emptyCartMessage.style.display = 'list-item';
                        } else {
                            emptyCartMessage.style.display = 'none';
                            state.cart.forEach((item, index) => {
                                const li = document.createElement('li');
                                li.textContent = item.name;
                                li.dataset.index = index;
                                cartItemsList.appendChild(li);
                            });
                        }
                        totalItemsSpan.textContent = state.cart.length;
                    }

                    // storage functions
                    function saveStateToStorage(){
                        
                        const payload = { 
                            cart: state.cart
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                        renderCart(); // Update UI after saving
                    }

                    function loadStateFromStorage(){
                        const raw = localStorage.getItem(STORAGE_KEY);
                        if(!raw) return;
                        try{
                            const obj = JSON.parse(raw);
                            if (obj && Array.isArray(obj.cart)) {
                                state.cart = obj.cart;
                            }
                        }catch(e){ console.warn('Failed parse state',e); }
                        renderCart();
                    }

                    // --- EVENT HANDLERS ---
                    toppingButtons.forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            toppingButtons.forEach(b=>b.style.border = '');
                            btn.style.border = '2px solid #2a9d8f';
                            state.selected = {id: btn.dataset.id, name: btn.dataset.name, src: btn.dataset.src};
                            document.getElementById('selectedName').textContent = state.selected.name;
                        });
                    });

                    addToCartButtons.forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            const pizzaName = btn.dataset.pizzaName;
                            state.cart.push({ type: 'specialty', name: pizzaName, toppings: [] });
                            saveStateToStorage();
                            alert(`${pizzaName} added to cart!`);
                        });
                    });

                    canvas.addEventListener('click', (e)=>{
                        if(!state.selected) return;
                        const {x,y} = canvasCoordsFromEvent(e);
                        const dx = x - cx, dy = y - cy;
                        const dist = Math.sqrt(dx*dx+dy*dy);
                        if(dist > OUTER_R) return;

                        const slice = getSliceIndexFromCoord(x,y);

                        const size = 40;
                        const entry = { id: state.selected.id, x, y, size };
                        state.slices[slice].push(entry);
                        redraw();
                    });

                    resetBtn.addEventListener('click', ()=>{
                        if(!confirm('Clear all custom pizza toppings?')) return;
                        state.slices = Array.from({length:NUM_SLICES}, ()=>[]);
                        redraw();
                    });
                    
                    // Add Custom Pizza to Cart
                    addCustomToCartBtn.addEventListener('click', ()=>{
                        const description = getCustomPizzaDescription(state.slices);
                        
                        
                        state.cart.push({
                            type: 'custom',
                            name: description,
                            slices: JSON.parse(JSON.stringify(state.slices))
                        });

                        
                        state.slices = Array.from({length:NUM_SLICES}, ()=>[]);
                        redraw();
                        
                        saveStateToStorage();
                        alert(`Custom Pizza added to cart! Start a new one!`);
                    });

                    finalCheckoutBtn.addEventListener('click', ()=>{
                        saveStateToStorage();
                        if (state.cart.length === 0) {
                            alert("Your cart is empty. Add a pizza first!");
                            return;
                        }
                        
                        let message = `You are checking out with ${state.cart.length} item(s)! \n`;
                        state.cart.forEach((item, index) => {
                            message += `${index + 1}. ${item.name}\n`;
                        });
                        alert(message);
                    });

                    Promise.all(preloadPromises).then(()=>{
                        loadStateFromStorage();
                        redraw();
                    });

                    // expose for debugging
                    window._pizzaBuilder = { state, redraw };
                })();
            </script>
        </main>

        <footer>
            <div>
                <p> &copy; The Flying Tomato 2025</p>
                <p>Contact us <a href="maltto:something@gmail.com">KT@theFlyingTomato.co</a></p>
            </div>
            <div>
                <h2>Follow Us on social media</h2>
                <div class="hover">
                <a href="https://www.facebook.com/theflyingtomato"><img src="./images/facebook.png" alt="Facebook Logo"></a>
                </div>
                <div class="hover">
                <a href="https://www.instagram.com/theflyingtomato"><img src="./images/instagram.png" alt="Instagram Logo"></a>
                </div>
                <div class="hover">
                <a href="https://www.twitter.com/theflyingtomato"><img src="./images/x.png" alt="X Logo"></a>
                </div>
            </div>
        </footer>
    </body>
</html>